<?php

# vim: set expandtab:
# vim: tabstop=2:
# vim: ai:
# vim: shiftwidth=2:

/**
 * @file
 * Module relating to the CEC_multilingual object model
 */

/** 
 * Implements hook_menu()
 */

function islandora_multilingual_menu() {
  $items = array();

  $items['admin/islandora/multilingual'] = array(
    'title' => 'Multilanguage',
    'description' => t('Administer the multilingual module'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_multilingual_admin_form'),
    'file' => 'admin/multilingual.admin.inc',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  // non-multilingual configuration: the "add" tab
  $items['islandora/object/%islandora_object/add'] = array(
    'title' => 'Add',
    'page callback' => 'islandora_basic_collection_ingest_action',
    'page arguments' => array(2),
    'file' => 'islandora_basic_collection.module',
    'file path' => drupal_get_path('module', 'islandora_basic_collection'),
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'modified_collection_add_access',
    'access arguments' => array(2),
  );
  // non-multilingual configuration: autocomplete paths
  $items['admin/islandora_multilingual/solr_autocomplete'] = array(
      'title' => 'autocomplete callback',
      'description' => 'Autocomplete from values in a solr field',
      'file' => 'includes/autocomplete.inc',
      'page callback' => 'islandora_multilingual_solr_autocomplete',
      'page arguments' => array(3,4),
      'access callback' => 'user_is_logged_in', 
      'type' => MENU_CALLBACK,
  );
  // non-multilingual configuration: autocomplete from hackily hard-coded files because I'm too lazy to port Islandora Autocomplete from 6
  $items['admin/islandora_multilingual/file_autocomplete'] = array(
      'title' => 'autocomplete callback',
      'description' => 'Autocomplete from JSON in a file.',
      'file' => 'includes/autocomplete.inc',
      'page callback' => 'islandora_multilingual_file_autocomplete',
      'page arguments' => array(3,4),
      'access callback' => 'user_is_logged_in',
      'type' => MENU_CALLBACK,
  );

  return $items;
}


/** 
 * Implements hook_variable_info()
 */
function islandora_multilingual_variable_info() {
  $variable = array();
  $variable['islandora_languages'] = array(
    'title' => t('Islandora languages'),
    'description' => t('Languages in which Islandora objects should be sought. This is the upper-case version of the language code in Drupal.'),
    'type' => 'string',
  );
}

/**
 * Implements hook_theme().
 */
function islandora_multilingual_theme($existing, $type, $theme, $path) {
  return array(
    // this includes some general theming that should be moved out.
    'islandora_multilingual' => array(
      'file' => 'theme/islandora_multilingual.theme.inc',
      'template' => 'theme/islandora-multilingual',
      'pattern' => 'islandora_multilingual__',
      'variables' => array('islandora_object' => NULL),
    ),
    'language_links' => array(
      'file' => 'theme/language_links.theme.inc',
      'template' => 'theme/language-links',
      'variables' => array('lang_array' => array()),
    ),
    // more general than multilingual
    'display_title' => array(
      'file' => 'theme/display_title.theme.inc',
      'template' => 'theme/display-title',
      'variables' => array('title' => '', 'subTitle' => ''),
    ),
  );
}

/**
 * Implements hook_CMODEL_PID_islandora_view_object().
 * FIXME this might be a good place to pass the language string...
 */
function islandora_multilingual_islandora_CEC_multilingual_islandora_view_object($object, $page_number, $page_size) {
  $output = theme('islandora_multilingual', array('islandora_object' => $object));
  return array('Multilingual View' => $output);
}

/**
 * Implements hook_islandora_ingest_steps().
 * though actually hook_islandora_CMODEL_PID_islandora_ingest_steps().
 * ORLY?
 */
function islandora_multilingual_islandora_CEC_multilingual_islandora_ingest_steps(array $configuration) {
  return array(
    'islandora_multlingual_pdf_file_upload' => array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'islandora_multilingual_pdf_upload_form',
      'module' => 'islandora_multilingual',
      'file' => 'includes/multilingual_upload.form.inc',
    )
  );
}

/** 
 * Implements hook_islandora_datastream_ingested().
 *
 * If a MODS ds was ingested, create the other languages.
 * If an OBJ ds was ingested, create the thumbnails.
 */
function islandora_multilingual_islandora_datastream_ingested($object, $datastream) {
  module_load_include('inc', 'islandora_multilingual', 'includes/Multilingual');
  if (preg_match('/MODS-/', $datastream->id) === 1) {
    $missing_ds = !(isset($object['MODS-EN']) and isset($object['MODS-ES']) and isset($object['MODS-FR']));
    if ($missing_ds) {
      multilingual_create_multiple_metadatastreams($object, $datastream);
      multilingual_synchronize_mods_datastreams($object, $datastream);
    } 
  }
  if (preg_match('/OBJ-.*/', $datastream->id) === 1) {
    islandora_multilingual_create_all_derivatives($object, $datastream->id);
  }
}

function islandora_multilingual_islandora_datastream_modified($object, $datastream) {
  module_load_include('inc', 'islandora_multilingual', 'includes/Multilingual');
  if (preg_match('/MODS-/', $datastream->id) === 1) {
    multilingual_synchronize_mods_datastreams($object, $datastream);
  }
}


/* 
 *  Find a better place for this - it's the permissions function for the Add tab to display.
 * Creates a shortcut "Add object" tab to the item menu for any object with CM islandora:collection
 * 
 */

function modified_collection_add_access($object = NULL) { 
    module_load_include('module', 'islandora_basic_collection', '');
    return islandora_basic_collection_ingest_access($object);
}

/** 
 * Fixme should go elsewhere
 * Alters the display of datastreams to include the last edited date.
 */
function islandora_multilingual_process_islandora_default_edit(&$variables) {
    $variables['datastream_table']['header'][] = array('data' => t('Last modified'));
    $i = 0;
    foreach ($variables['islandora_object'] as $ds) {
        $variables['datastream_table']['rows'][$i][] = array(
            'class' => 'datastream_modified', 
            'data' => $ds->createdDate,
        );
        $i = $i + 1;
    }
}
/**
 * Implements hook_form_alter()
 *
 * points to our submit and validate methods instead of the islandora ones.
 * This only affects it when called as the "edit" form, not the "ingest" form.
 */
function islandora_multilingual_form_alter(&$form, $form_state, $form_id) {
 if ($form_id == 'xml_form_builder_edit_datastream_form') {
   array_unshift($form['#validate'], 'islandora_multilingual_datastream_form_validate');
 }
 if ($form_id == 'islandora_ingest_form') {
   array_unshift($form['#validate'], 'islandora_multilingual_datastream_form_validate');
 }

}

/*
 * This custom validation function runs after you edit metadata using a mods form
 * either when ingesting or when editing an existing datastream.
 *
 * It clears the unselected checkbox elements (so as to not write their nodes)
 *
 * It marks this datastream as "master".
 */
function islandora_multilingual_datastream_form_validate(array &$form, array &$form_state) {
    $should_clear = FALSE;

    if (($form['#form_id'] == 'islandora_ingest_form') and ($form_state['islandora']['step_id'] == 'xml_form_builder_metadata_step') and ($form_state['clicked_button']['#value']  == 'Next')) {
        $should_clear = TRUE;
    } elseif (($form['#form_id'] == 'xml_form_builder_edit_datastream_form') and ($form_state['clicked_button']['#value']  == 'Update')) {
        $should_clear = TRUE;
    } 

    if ($should_clear) {
        // Clear out the unselected keyword and language checkboxes from $form_state['storage'].
        $root = $form_state['storage']['objective_form_storage']['root'];
        foreach ($form_state['values']['Keywords'] as $keyword => $value) {
          if ($value == '0') {
            // Note: test against the string '0' to avoid string-to-int conversion weirdness. 
            unset($root->children['Keywords']->children[$keyword]);
          }
        }
        if ($form_state['values']['Language'] == '0') {
            unset($root->children['Language']);
        }

        // Mark this datastream as "master"
        $form_state['values']['master'] = 'yes';
    }
	//dpm($form_state);
  //form_set_error('error');
}


/**
 * Implements hook_form_FORM_ID_alter()
 *
 * Alters the add datastream form to not let the user access the 'Label' field.
 * Prepends our validation function which copies the filename to the label field.
 */
function islandora_multilingual_form_islandora_add_datastream_form_alter(&$form, $form_state) {
    $form['label']['#type'] = 'hidden';
    $form['label']['#value'] = 'Datastream label';
    array_unshift($form['#validate'], 'islandora_multilingual_add_datastream_form_validate');
}

/**
 * Copies the name of the uploaded file to the label field in add_datastream_form.
 */
function islandora_multilingual_add_datastream_form_validate(array &$form, array &$form_state) {
    $file = file_load($form_state['values']['file']);
    $form_state['values']['label'] = $file->filename;
    $form_state['input']['label'] = $file->filename;
}




/**
 * Implements hook_xml_form_builder_get_transforms().
 *
 * Grabs any XSLTs from the "transforms" directory inside of this module.
 */

function islandora_multilingual_xml_form_builder_get_transforms() {
  $p = drupal_get_path('module', 'islandora_multilingual');
  $transforms = array();
  $include_path = "$p/transforms";
  $dir = opendir($include_path);
  if ($dir !== FALSE) {
    while (($file = readdir($dir)) !== FALSE) {
      if (preg_match('/\.xslt?$/', $file)) {
        $transforms["$file"] = "$include_path/$file";
      }
    }
  }
  closedir($dir);
  return $transforms;
}

